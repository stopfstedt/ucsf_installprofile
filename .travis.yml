language: php

php:
- 5.3
- 5.4
- 5.5

addons:
  sauce_connect: true

env:
  global:
  # sauce credentials
  - secure: Zf1xeZarvGyx5cvpaBhJpYLmRLzS7Ys0SJokGeOHWV0nmC04tloRxAvF+//XRPDlPyrSg+6s/WMUW4txEOALG3BEZ+Zufa1ERrP/hO9inDPgjz6xULLIzyn6aUlxqsD26GIp4ARN7Opxz9sGF04M8d7o2LT/Beor4IPW2VyfwMc=
  - secure: u3HofJW0YT3zJKNGan87j1FxVmZSWNBAzaEyqcpWzUy8bwpIrmS91Cp9oC0Su3lI+J9+CkyPUZuaXTwFMqc/xFvgcANKmHUB6fp9dHS7qrLZSNCzMW/+5DWV46FItv1C5jI03eghwmvhEtIyCBsCH1jo19jM8bYSA7VJLxC7tp8=
  matrix:
  - BEHAT_PROFILE='default'
  - BEHAT_PROFILE='winxpie7'
  - BEHAT_PROFILE='win7ie8'
  - BEHAT_PROFILE='win7ie9'
  - BEHAT_PROFILE='win7ie10'
  - BEHAT_PROFILE='win8ie11'
  - BEHAT_PROFILE='osxchrome'
  - BEHAT_PROFILE='osxsafari'
  - BEHAT_PROFILE='phantomjs'

matrix:
  fast_finish: true
  exclude:
  - php: 5.4
  - php: 5.5
  include:
  - php: 5.4
    env: BEHAT_PROFILE="phantomjs"
  - php: 5.5
    env: BEHAT_PROFILE="phantomjs"

mysql:
  username: root
  encoding: utf8

before_install:
- composer self-update
- sudo apt-get update -qq

install:
# install php packages required for running a web server from drush on php 5.4
- sudo apt-get install -y --force-yes php5-cgi php5-mysql

# install apache
- sudo apt-get install apache2 libapache2-mod-fastcgi

# add composer's global bin directory to the path
# see: https://github.com/drush-ops/drush#install---composer
- sed -i '1i export PATH="$HOME/.composer/vendor/bin:$PATH"' $HOME/.bashrc
- source $HOME/.bashrc

# install drush globally
- composer global require drush/drush:6.*

# install behat and co
- composer install -d tests/behat

before_script:
# enable php-fpm
- sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
- sudo a2enmod rewrite actions fastcgi alias
- echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
- ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm

# create a new database
- mysql -e 'CREATE DATABASE starterkit'

# start Selenium as hub server for Behat tests
- if [ "$BEHAT_PROFILE" = "phantomjs" ]; then (java -jar ${TRAVIS_BUILD_DIR}/tests/behat/bin/selenium-server.jar -role hub > /dev/null &); fi
- if [ "$BEHAT_PROFILE" = "phantomjs" ]; then (until netstat -an 2>/dev/null | grep '4444.*LISTEN'; do true; done); fi

# start Phantom for headless Behat tests
- if [ "$BEHAT_PROFILE" = "phantomjs" ]; then (phantomjs --webdriver=8080 --webdriver-selenium-grid-hub=http://127.0.0.1:4444 --ignore-ssl-errors=true > /dev/null &); fi
- if [ "$BEHAT_PROFILE" = "phantomjs" ]; then (until netstat -an 2>/dev/null | grep '8080.*LISTEN'; do true; done); fi

script:

# build drupal and the profile into the webroot dir
- drush make --prepare-install make/build-ucsf_installprofile-ci.make webroot

# build modules/themes/libs into a temp dir
- drush make --no-cache --contrib-destination="." --no-core make/drupal-org.make tmp
# move the temp directory's content into sites/all
- cp -r tmp/* webroot/sites/all/
# delete temp dir
- rm -rf tmp

# move the webroot out of the profile to prevent path clobbering
- mv webroot $TRAVIS_BUILD_DIR/../webroot

- cd $TRAVIS_BUILD_DIR/../webroot

# symlink to profile from the /profiles directory
- ln -s $TRAVIS_BUILD_DIR profiles/ucsf_installprofile

# configure apache virtual hosts
- sudo cp -f $TRAVIS_BUILD_DIR/build/travis-ci-apache /etc/apache2/sites-available/default
- sudo sed -e "s?%DOCROOT%?$(pwd)?g" --in-place /etc/apache2/sites-available/default

# restart apache
- sudo service apache2 restart
- until netstat -an 2>/dev/null | grep '80.*LISTEN'; do true; done

# create new site, stubbing sendmail path with true to prevent delivery errors and manually
- php -d sendmail_path=`which true` ~/.composer/vendor/bin/drush.php --yes site-install ucsf_installprofile --db-url=mysql://root:@127.0.0.1/starterkit

# run behat tests
- ${TRAVIS_BUILD_DIR}/tests/behat/bin/behat -c ${TRAVIS_BUILD_DIR}/tests/behat/behatci.yml -p ${BEHAT_PROFILE}
